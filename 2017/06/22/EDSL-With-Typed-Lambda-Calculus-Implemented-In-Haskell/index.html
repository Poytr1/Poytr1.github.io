<!DOCTYPE html>
<html lang="zh">
    <head>
    <!-- 
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.0 -->

    <!-- Title -->
    
    <title>
        
            EDSL With Typed Lambda Calculus Implemented In Haskell | 
        
        Freedom Is Slavery Ignorance Is Strength
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Meta & Info -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="Peterson Xu">
    <meta name="description" content="null">
    <meta name="keywords" content="null,Haskell">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Freedom Is Slavery Ignorance Is Strength">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://poytr1.github.io">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="EDSL With Typed Lambda Calculus Implemented In Haskell | Freedom Is Slavery Ignorance Is Strength">
    <meta property="og:description" content="null">
    <meta property="og:article:tag" content="Haskell"> 

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }
</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-image: url(/img/bg.png);
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>



    <script src="/js/jquery.min.js"></script>
    <script src="/js/queue.js"></script>

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    

    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#EDSL-With-Typed-Lambda-Calculus-Implemented-In-Haskell"><span class="post-toc-number">1.</span> <span class="post-toc-text">EDSL With Typed Lambda Calculus Implemented In Haskell</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Abstract"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">Abstract</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Binding"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">Binding</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Expression-problem"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">Expression problem</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Object-algebras-amp-finally-tagless"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">Object algebras & finally tagless</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#The-very-beginning-problem"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">The very beginning problem</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Conclusion"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">Conclusion</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#References"><span class="post-toc-number">1.7.</span> <span class="post-toc-text">References</span></a></li></ol></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').css('background-image', 'url(' + '/img/random/material-' + randomNum + '.png' + ')');
</script>

        
    
            <p class="article-headline-p">
                EDSL With Typed Lambda Calculus Implemented In Haskell
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/face.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Peterson Xu</strong>
        <span>6月 22, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/Haskell/">Haskell</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=EDSL With Typed Lambda Calculus Implemented In Haskell&url=http://poytr1.github.io//2017/06/22/EDSL-With-Typed-Lambda-Calculus-Implemented-In-Haskell/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=EDSL With Typed Lambda Calculus Implemented In Haskell&url=http://poytr1.github.io//2017/06/22/EDSL-With-Typed-Lambda-Calculus-Implemented-In-Haskell/index.html&via=Peterson Xu" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://poytr1.github.io//2017/06/22/EDSL-With-Typed-Lambda-Calculus-Implemented-In-Haskell/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://poytr1.github.io//2017/06/22/EDSL-With-Typed-Lambda-Calculus-Implemented-In-Haskell/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h1 id="EDSL-With-Typed-Lambda-Calculus-Implemented-In-Haskell"><a href="#EDSL-With-Typed-Lambda-Calculus-Implemented-In-Haskell" class="headerlink" title="EDSL With Typed Lambda Calculus Implemented In Haskell"></a>EDSL With Typed Lambda Calculus Implemented In Haskell</h1><h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p>Haskell是一种丰富的语言，它具有各种扩展功能。另外，我们可以将我们定义的语言(比如DSLs)中的lambda表达式embed到或者映射到Haskell中的lambda表达式中，这就是所谓的HOAS(Higher Order Abstract Syntax)。同时我们可以利用FInally Tagless，可以将HOAS表示成SKI Combinator的形式，最后可以添加Y Combinator实现带类型的计算，同时还能拥有很好的extensibility与类型安全。</p>
<h2 id="Binding"><a href="#Binding" class="headerlink" title="Binding"></a>Binding</h2><p>Lambda演算虽然非常简单，但是在计算与实现Lambda表达式规约上却有很多方法，主要是在计算策略上的不同，按模型主要分为三类：</p>
<ol>
<li>Call-by-value:arguments are evaluated before a function is entered</li>
<li>Call-by-name:arguments passed unevaluated</li>
<li>Call-by-need:arguments passed unevaluated but an expression is only evaluated once and shared upon subsequent references</li>
</ol>
<p>在不同模型下的规约步骤不同:</p>
<p><em>Call-by-value</em>:</p>
<ol>
<li>Evaluate <em>x</em> to <em>v</em></li>
<li>Evaluate <em>f</em> to <em>λy.e</em></li>
<li>Evaluate <em>[y/v]e</em></li>
</ol>
<p><em>Call-by-name</em>:</p>
<ol>
<li>Evaluate <em>f</em> to <em>λy.e</em></li>
<li>Evaluate <em>[y/x]e</em></li>
</ol>
<p><em>Call-by-need</em>:</p>
<ol>
<li>Allocate a thunk <em>v</em> for <em>x</em></li>
<li>Evaluate <em>f</em> to <em>λy.e</em></li>
<li>Evaluate <em>[y/v]e</em></li>
</ol>
<p>不管是哪种模型什么策略，都会遇到一个问题，即最后一步做substitution的时候，该如何正确地表示binding。最朴素的想法，substitution就是替换，我们完全可以将后面的expression看做字符串去替换前面变量所有的出现，这样就是一个简单的字符串匹配的问题了，用Haskell强大的模式匹配很快就能解决，代码如下:</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token keyword">data</span> <span class="token constant">Expr</span> <span class="token operator">=</span> <span class="token constant">Var</span> <span class="token constant">String</span> <span class="token operator">|</span> <span class="token constant">Abs</span> <span class="token constant">String</span> <span class="token constant">Expr</span> <span class="token operator">|</span> <span class="token constant">App</span> <span class="token constant">Expr</span> <span class="token constant">Expr</span> <span class="token keyword">deriving</span> <span class="token punctuation">(</span><span class="token constant">Show</span><span class="token punctuation">,</span> <span class="token constant">Eq</span><span class="token punctuation">)</span>

<span class="token hvariable">eval</span> <span class="token operator">::</span> <span class="token constant">Expr</span> <span class="token operator">-></span> <span class="token constant">Expr</span> 
<span class="token hvariable">eval</span> <span class="token punctuation">(</span><span class="token constant">Var</span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">Var</span> <span class="token hvariable">x</span> 
<span class="token hvariable">eval</span> <span class="token punctuation">(</span><span class="token constant">Abs</span> <span class="token hvariable">x</span> <span class="token hvariable">e</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">Abs</span> <span class="token hvariable">x</span> <span class="token punctuation">(</span><span class="token hvariable">eval</span> <span class="token hvariable">e</span><span class="token punctuation">)</span>
<span class="token hvariable">eval</span> <span class="token punctuation">(</span><span class="token constant">App</span> <span class="token hvariable">l</span><span class="token operator">@</span><span class="token punctuation">(</span><span class="token constant">Var</span> <span class="token hvariable">_</span><span class="token punctuation">)</span> <span class="token hvariable">r</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">App</span> <span class="token hvariable">l</span> <span class="token punctuation">(</span><span class="token hvariable">eval</span> <span class="token hvariable">r</span><span class="token punctuation">)</span>
<span class="token hvariable">eval</span> <span class="token punctuation">(</span><span class="token constant">App</span> <span class="token hvariable">l</span><span class="token operator">@</span><span class="token punctuation">(</span><span class="token constant">App</span> <span class="token hvariable">_</span> <span class="token hvariable">_</span><span class="token punctuation">)</span> <span class="token hvariable">r</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">eval</span> <span class="token punctuation">(</span><span class="token constant">App</span> <span class="token punctuation">(</span><span class="token hvariable">eval</span> <span class="token hvariable">l</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token hvariable">eval</span> <span class="token hvariable">r</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token hvariable">eval</span> <span class="token punctuation">(</span><span class="token constant">App</span> <span class="token punctuation">(</span><span class="token constant">Abs</span> <span class="token hvariable">x</span> <span class="token hvariable">l</span><span class="token punctuation">)</span> <span class="token hvariable">r</span><span class="token punctuation">)</span> <span class="token operator">=</span> 
    <span class="token hvariable">eval</span> <span class="token punctuation">(</span><span class="token hvariable">subst</span> <span class="token hvariable">l</span><span class="token punctuation">)</span> <span class="token keyword">where</span>
    <span class="token hvariable">subst</span> <span class="token punctuation">(</span><span class="token constant">Var</span> <span class="token hvariable">x</span>'<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token hvariable">x</span> <span class="token operator">==</span> <span class="token hvariable">x</span>' <span class="token operator">=</span> <span class="token hvariable">r</span>
    <span class="token hvariable">subst</span> <span class="token punctuation">(</span><span class="token constant">Var</span> <span class="token hvariable">x</span>'<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token hvariable">x</span> <span class="token operator">/=</span> <span class="token hvariable">x</span>' <span class="token operator">=</span> <span class="token constant">Var</span> <span class="token hvariable">x</span>'
    <span class="token hvariable">subst</span> <span class="token punctuation">(</span><span class="token constant">Abs</span> <span class="token hvariable">x</span>' <span class="token hvariable">y</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token hvariable">x</span> <span class="token operator">==</span> <span class="token hvariable">x</span>' <span class="token operator">=</span> <span class="token constant">Abs</span> <span class="token hvariable">x</span>' <span class="token hvariable">y</span>
    <span class="token hvariable">subst</span> <span class="token punctuation">(</span><span class="token constant">Abs</span> <span class="token hvariable">x</span>' <span class="token hvariable">y</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token hvariable">x</span> <span class="token operator">/=</span> <span class="token hvariable">x</span>' <span class="token operator">=</span> <span class="token constant">Abs</span> <span class="token hvariable">x</span>' <span class="token punctuation">(</span><span class="token hvariable">subst</span> <span class="token hvariable">y</span><span class="token punctuation">)</span>
    <span class="token hvariable">subst</span> <span class="token punctuation">(</span><span class="token constant">App</span> <span class="token hvariable">ll</span> <span class="token hvariable">lr</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">App</span> <span class="token punctuation">(</span><span class="token hvariable">subst</span> <span class="token hvariable">ll</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token hvariable">subst</span> <span class="token hvariable">lr</span><span class="token punctuation">)</span>
</code></pre>
<p>考虑这样的一个Lambda表达式<code>\y(\x\y x)y</code></p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token hvariable">term</span> <span class="token operator">=</span> <span class="token constant">Abs</span> <span class="token string">"y"</span> <span class="token punctuation">(</span><span class="token constant">App</span> <span class="token punctuation">(</span><span class="token constant">Abs</span> <span class="token string">"x"</span> <span class="token punctuation">(</span><span class="token constant">Abs</span> <span class="token string">"y"</span> <span class="token punctuation">(</span><span class="token constant">Var</span> <span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token constant">Var</span> <span class="token string">"y"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token hvariable">main</span> <span class="token operator">=</span> <span class="token builtin">putStr</span> <span class="token operator">$</span> <span class="token builtin">show</span> <span class="token operator">$</span> <span class="token hvariable">eval</span> <span class="token hvariable">term</span>
</code></pre>
<p>运行结果为<code>Abs &quot;y&quot; (Abs &quot;y&quot; (Var &quot;y&quot;))</code>，这样语义就改变了(\x \y x -&gt; \y y变成了与y变量有关的函数)。</p>
<p>所以单纯的字符串替换是不行的，他不能看到一个Lambda表达式中的语义信息所以会出现改变语义的substitution，我们需要需求一种替换，不会出现语义改变的问题，这种替换被称为capture-avoiding substitution（CAS）。</p>
<p>一种主流的方法是将语言embed到另一种metalanguage中，这样我们就借来了metalanguage中的binding，这叫做HOAS。</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token keyword">data</span> <span class="token constant">Expr</span> <span class="token operator">=</span> <span class="token constant">Lam</span> <span class="token punctuation">(</span><span class="token constant">Expr</span> <span class="token operator">-></span> <span class="token constant">Expr</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token constant">App</span> <span class="token constant">Expr</span> <span class="token constant">Expr</span>
</code></pre>
<p>我们定义Expr方式也与定义普通的Lambda function类似，同时对表达式的计算也变得简单了，可以简单地使用Haskell来计算。</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token hvariable">y</span> <span class="token operator">=</span> <span class="token constant">Lam</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">f</span> <span class="token operator">-></span> <span class="token keyword">let</span> <span class="token hvariable">e</span> <span class="token operator">=</span> <span class="token constant">Lam</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">x</span> <span class="token operator">-></span> <span class="token constant">App</span> <span class="token hvariable">f</span> <span class="token punctuation">(</span><span class="token constant">App</span> <span class="token hvariable">x</span> <span class="token hvariable">x</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token constant">App</span> <span class="token hvariable">e</span> <span class="token hvariable">e</span><span class="token punctuation">)</span>

<span class="token hvariable">eval</span> <span class="token punctuation">(</span><span class="token constant">Lam</span> <span class="token hvariable">l</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">Lam</span> <span class="token hvariable">l</span>
<span class="token hvariable">eval</span> <span class="token punctuation">(</span><span class="token constant">App</span> <span class="token punctuation">(</span><span class="token constant">Lam</span> <span class="token hvariable">l</span><span class="token punctuation">)</span> <span class="token hvariable">r</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">eval</span> <span class="token punctuation">(</span><span class="token hvariable">l</span> <span class="token hvariable">r</span><span class="token punctuation">)</span>
<span class="token hvariable">eval</span> <span class="token punctuation">(</span><span class="token constant">App</span> <span class="token hvariable">l</span> <span class="token hvariable">r</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">eval</span> <span class="token punctuation">(</span><span class="token constant">App</span> <span class="token punctuation">(</span><span class="token hvariable">eval</span> <span class="token hvariable">l</span><span class="token punctuation">)</span> <span class="token hvariable">r</span><span class="token punctuation">)</span>
</code></pre>
<p>这样的形式目前看来很不错，很好并且很优雅地解决了binding的问题，但是这样的形式是不是完美的呢？很显然存在很多麻烦之处。</p>
<p>首先，我们需要更多时间考虑怎么把一个expression转换成这种的形式，因为我们需要使用Haskell本身的Lambda binder。另外，由于所有的机制都包在Haskell的实现里面，所以即使像PretyPrint/Optimization/writing transformation passes这种简单的操作都会变得异常困难，我们很难看到一个函数本身的结构。所以这种形式只是适合计算的一种很好的形式，并不适合通用的转换。那么我们能不能找到一种方法在保留HOAS优势的同时简单地支持这些操作呢？</p>
<h2 id="Expression-problem"><a href="#Expression-problem" class="headerlink" title="Expression problem"></a>Expression problem</h2><p>首先来看一个expression的问题。这里用经典的“Hutton’s Razor”作为例子，它是使用加法运算+从整数文字建立的简单算术表达式的语言，在Haskell中可以这么表示：</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token keyword">data</span> <span class="token constant">Exp</span> <span class="token operator">=</span> <span class="token constant">Lit</span> <span class="token constant">Int</span> <span class="token operator">|</span> <span class="token constant">Add</span> <span class="token constant">Exp</span> <span class="token constant">Exp</span>
</code></pre>
<p>这样，比如表达式(1+(2+3))就可以写成：</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token hvariable">e1</span> <span class="token operator">=</span> <span class="token constant">Add</span> <span class="token punctuation">(</span><span class="token constant">Lit</span> <span class="token number">1</span><span class="token punctuation">)</span>
         <span class="token punctuation">(</span><span class="token constant">Add</span> <span class="token punctuation">(</span><span class="token constant">Lit</span> <span class="token number">2</span><span class="token punctuation">)</span>
               <span class="token punctuation">(</span><span class="token constant">Lit</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>给他写一个eval能够计算形如上面的表达式的值:</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token hvariable">eval</span> <span class="token operator">::</span> <span class="token constant">Exp</span> <span class="token operator">-></span> <span class="token constant">Int</span>
<span class="token hvariable">eval</span> <span class="token punctuation">(</span><span class="token constant">Lit</span> <span class="token hvariable">n</span><span class="token punctuation">)</span>   <span class="token operator">=</span> <span class="token hvariable">n</span>
<span class="token hvariable">eval</span> <span class="token punctuation">(</span><span class="token constant">Add</span> <span class="token hvariable">x</span> <span class="token hvariable">y</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">eval</span> <span class="token hvariable">x</span> <span class="token operator">+</span> <span class="token hvariable">eval</span> <span class="token hvariable">y</span>
</code></pre>
<p>我们可以很简单的为我们的Exp增加一个函数（比如pretty printing）:</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token hvariable">prettyprint</span> <span class="token operator">::</span> <span class="token constant">Exp</span> <span class="token operator">-></span> <span class="token constant">String</span>
<span class="token hvariable">prettyprint</span> <span class="token punctuation">(</span><span class="token constant">Lit</span> <span class="token hvariable">n</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">show</span> <span class="token hvariable">n</span> 
<span class="token hvariable">prettyprint</span> <span class="token punctuation">(</span><span class="token constant">Add</span> <span class="token hvariable">x</span> <span class="token hvariable">y</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"("</span> <span class="token operator">++</span> <span class="token hvariable">prettyprint</span> <span class="token hvariable">x</span> <span class="token operator">++</span> <span class="token string">"x"</span> <span class="token operator">++</span>
                        <span class="token hvariable">prettyprint</span> <span class="token hvariable">y</span> <span class="token operator">++</span> <span class="token string">")"</span>
</code></pre>
<p>并且不会影响到Exp的extensibility与type safe(我们根本不需要对Exp的constructor进行改变)。但是，当我们试着对我们定义的这个语言表达式做运算符的拓展的时候(比如添加一个乘法运算*)，事情好像就比较麻烦了。首先需要在数据类型Exp中增加一个Mult的constructor，我们还需要在每个涉及到Exp的function中添加case，比如上面的eval与prettyprint。真实世界事件的规模比我们举的这个例子大很多，存在多涉及到类似定义的数据类型的function，作为一个代码的维护者，必须极其小心检查每个function并为每个function加上独特的case——十分煎熬。所以这样的方法不能在为数据类型增加constructor的时候同时保持我们语言的extensibility与type safe。</p>
<p>这是用函数式语言会遇到的问题，我们再尝试用OO的语言实现，看有没有相同的问题。</p>
<p>在Java中定义一个Exp的接口，提供一个抽象方法eval()，上面每个constructor都可以写成继承这个Exp的类，并且实现它的抽象方法:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">Exp</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Lit</span> <span class="token keyword">implements</span> <span class="token class-name">Exp</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> n<span class="token punctuation">;</span>
    <span class="token function">Lit</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>n <span class="token operator">=</span> n<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> n<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Add</span> <span class="token keyword">implements</span> <span class="token class-name">Exp</span> <span class="token punctuation">{</span>
    Exp x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
    <span class="token function">Add</span><span class="token punctuation">(</span>Exp l<span class="token punctuation">,</span> Exp r<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> l<span class="token punctuation">;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> r<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> x<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>尝试为其添加一个*运算，会发现简单很多，简单地再继承一下：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Mult</span> <span class="token keyword">implements</span> <span class="token class-name">Exp</span> <span class="token punctuation">{</span>
  Exp x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
  <span class="token function">Mult</span><span class="token punctuation">(</span>Exp l<span class="token punctuation">,</span> Exp r<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> l<span class="token punctuation">;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> r<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">int</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> x<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> y<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>我们不需要碰到其他地方，只用简单地再增加实现一个类就行了。这么看来刚刚函数式语言的问题得到了很好的解决，但是同时带来了新的问题，添加新的方法（比如prettyprint）显得很困难，我们需要对每个class分别实现，即问题完全反过来了。</p>
<p>这种问题被称作expression problem，有一种很直观的解释。</p>
<p>考虑这样的长方形表格，列代表操作，行代表表达式的类型。表格中的元素代表相关类型的相关操作。</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">Eval</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Lit</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">Add</td>
</tr>
</tbody>
</table>
<p>在函数式语言中，这个表格中元素的定义是以列为单位的。一列所代表的函数表示一个对所有表达式类型的操作。所以在添加一个新的操作(function)的时候即添加新一列的时候很简单。但是在表达式类型即行这个维度上的可扩展性就没这么强了，因为对每列添加一个新行，每个交都是一个新的case，所以很困难。</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">Eval</th>
<th style="text-align:center">Prettyprint</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Lit</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">Add</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">Mult</td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<p>在面向对象的语言中，表格中元素的定义是由行组织的。每行所代表的表达式类型包含了这个类型下所有的操作(function)。所以对于面向对象语言而言，对于表达式类型的扩展是比较简单的，事实上只要添加一个新的Class。然而添加新的操作即在表格中添加一列比较困难，因为我们要在每个相关的class里面添加这个方法。</p>
<p>于是expression problem呼之欲出：能否在这个表格的横纵两个维度上都保持很好的扩展性同时又不失static guarantees且无需修改已有的代码呢？</p>
<h2 id="Object-algebras-amp-finally-tagless"><a href="#Object-algebras-amp-finally-tagless" class="headerlink" title="Object algebras &amp; finally tagless"></a>Object algebras &amp; finally tagless</h2><p>Object algebras是一个比较新的用来解决expression problem的OO设计模式。它是在<a href="https://www.cs.utexas.edu/~wcook/Drafts/2012/ecoop2012.pdf" target="_blank" rel="external">“Extensiblity for the Masses”</a>这篇文章中提出的，之所以收到推崇是因为他用相当简洁优雅的方式解决了expression problem，不需要对现有语言本身做拓展，在主流语言Java或者C#中就能实现。</p>
<p>Object algebras的主要想法与软件工程中的抽象工厂模式很像，即定义一个接口与其中的抽象方法，这样我们就可以用这个工厂来表示表达式，并生产具体的操作工厂。Java代码如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">ExpAlg</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    T <span class="token function">lit</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    T <span class="token function">add</span><span class="token punctuation">(</span>T x<span class="token punctuation">,</span> T y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">Eval</span> <span class="token punctuation">{</span> <span class="token keyword">int</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">EvalExp</span> <span class="token keyword">implements</span> <span class="token class-name">ExpAlg</span><span class="token operator">&lt;</span>Eval<span class="token operator">></span> <span class="token punctuation">{</span>
    Eval <span class="token function">lit</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> n<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Eval <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">final</span> Eval x<span class="token punctuation">,</span> <span class="token keyword">final</span> Eval y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">int</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token keyword">return</span> x<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这样表达式<code>(1 + (2 + 3))</code> 可以表示为:</p>
<pre class=" language-java"><code class="language-java"><span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">e1</span><span class="token punctuation">(</span>ExpAlg<span class="token operator">&lt;</span>T<span class="token operator">></span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
        f<span class="token punctuation">.</span><span class="token function">lit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        f<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
            f<span class="token punctuation">.</span><span class="token function">lit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            f<span class="token punctuation">.</span><span class="token function">lit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>很简单地来计算e1的值:</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> v1 <span class="token operator">=</span> <span class="token function">e1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EvalExp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>首先来看看怎么在我们的语言中添加新的表达式类型‘乘法’。第一个想到的方法当然是在我们所定义的接口<code>ExpAlg&lt;T&gt;</code>中添加新的方法<code>Mult</code>，那么就回到了我们刚刚遇到的问题。</p>
<p>不改变原有的代码，考虑定义一个新的interface来 <em>extends</em> 我们之前定义的“工厂”：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">MulAlg</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">extends</span> <span class="token class-name">ExpAlg</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    T <span class="token function">mul</span><span class="token punctuation">(</span>T x<span class="token punctuation">,</span> T y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>同时对这个新的表达式类型的计算该怎么实现呢，也很简单与前面类似<em>extends</em> EvalExp类即可：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">EvalMul</span> <span class="token keyword">extends</span> <span class="token class-name">EvalExp</span> <span class="token keyword">implements</span> <span class="token class-name">MulAlg</span><span class="token operator">&lt;</span>Eval<span class="token operator">></span> <span class="token punctuation">{</span>
    Eval <span class="token function">mul</span><span class="token punctuation">(</span><span class="token keyword">final</span> Eval x<span class="token punctuation">,</span> <span class="token keyword">final</span> Eval y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> x<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> y<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这样我们做到了<strong>在完全不触碰到原有的代码情况下添加了新的表达式类型‘乘法’</strong>。</p>
<p>再来看看如何添加新的操作(function)，比如prettyprint。定义一个新的接口，并且实现用它生产具体的工厂：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">Prettyprint</span> <span class="token punctuation">{</span> String <span class="token function">prettyprint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">PrettyprintExp</span> <span class="token keyword">implements</span> <span class="token class-name">ExpAlg</span><span class="token operator">&lt;</span>Prettyprint<span class="token operator">></span> <span class="token punctuation">{</span>
    Prettyprint <span class="token function">lit</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Prettyprint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String <span class="token function">Prettyprint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> Integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">PrettyprintMul</span> <span class="token keyword">extends</span> <span class="token class-name">PrettyprintExp</span> <span class="token keyword">implements</span> <span class="token class-name">MulAlg</span><span class="token operator">&lt;</span>Prettyprint<span class="token operator">></span> <span class="token punctuation">{</span>
    Prettyprint <span class="token function">mult</span><span class="token punctuation">(</span><span class="token keyword">final</span> Prettyprint x<span class="token punctuation">,</span> <span class="token keyword">final</span> Prettyprint y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Prettyprint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String <span class="token function">Prettyprint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">"("</span> <span class="token operator">+</span> x<span class="token punctuation">.</span><span class="token function">Prettyprint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" * "</span> <span class="token operator">+</span> y<span class="token punctuation">.</span><span class="token function">Prettyprint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里抽象工厂接口<code>ExpAlg&lt;T&gt;</code>被称为对象代数接口，实现它的具体工厂称为对象代数。这个方法是受抽象代数的启发，抽象代数中代数结构由签名描述，签名作为一个接口，说明了在代数结构的基础集上定义的操作类型，一个代数提供这些操作的具体定义，类似于实现接口的类。</p>
<p>我们现在把上面的例子从Java代码转成Haskell代码，从而实现finally tagless。这个方法是在<a href="https://www.cs.rutgers.edu/~ccshan/tagless/jfp.pdf" target="_blank" rel="external">“Finally Tagless, Partially Evaluated”</a>这篇文章中提出的。</p>
<p>Java中的interface对应Haskell中的Typeclass,class对应instance：</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token keyword">class</span> <span class="token constant">ExpAlg</span> <span class="token hvariable">t</span> <span class="token keyword">where</span>
    <span class="token hvariable">lit</span> <span class="token operator">::</span> <span class="token constant">Int</span> <span class="token operator">-></span> <span class="token hvariable">t</span>
    <span class="token hvariable">add</span> <span class="token operator">::</span> <span class="token hvariable">t</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token operator">-></span> <span class="token hvariable">t</span>

<span class="token keyword">newtype</span> <span class="token constant">Eval</span> <span class="token operator">=</span> <span class="token constant">Eval</span> <span class="token punctuation">{</span> <span class="token hvariable">eval</span> <span class="token operator">::</span> <span class="token constant">Int</span> <span class="token punctuation">}</span>

<span class="token keyword">instance</span> <span class="token constant">ExpAlg</span> <span class="token constant">Eval</span> <span class="token keyword">where</span>
    <span class="token hvariable">lit</span> <span class="token hvariable">n</span>   <span class="token operator">=</span> <span class="token constant">Eval</span> <span class="token hvariable">n</span>
    <span class="token hvariable">add</span> <span class="token hvariable">x</span> <span class="token hvariable">y</span> <span class="token operator">=</span> <span class="token constant">Eval</span> <span class="token operator">$</span> <span class="token hvariable">eval</span> <span class="token hvariable">x</span> <span class="token operator">+</span> <span class="token hvariable">eval</span> <span class="token hvariable">y</span>
</code></pre>
<p>现在可以两边扩展了：</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token keyword">instance</span> <span class="token constant">MulAlg</span> <span class="token constant">Eval</span> <span class="token keyword">where</span>
    <span class="token hvariable">mul</span> <span class="token hvariable">x</span> <span class="token hvariable">y</span> <span class="token operator">=</span> <span class="token constant">Eval</span> <span class="token operator">$</span> <span class="token hvariable">eval</span> <span class="token hvariable">x</span> <span class="token operator">*</span> <span class="token hvariable">eval</span> <span class="token hvariable">y</span>

<span class="token keyword">newtype</span> <span class="token constant">Prettyprint</span> <span class="token operator">=</span> <span class="token constant">Prettyprint</span> <span class="token punctuation">{</span> <span class="token hvariable">prettyprint</span> <span class="token operator">::</span> <span class="token constant">String</span> <span class="token punctuation">}</span>

<span class="token keyword">instance</span> <span class="token constant">ExpAlg</span> <span class="token constant">Prettyprint</span> <span class="token keyword">where</span>
    <span class="token hvariable">lit</span> <span class="token hvariable">n</span>   <span class="token operator">=</span> <span class="token constant">Prettyprint</span> <span class="token operator">$</span> <span class="token builtin">show</span> <span class="token hvariable">n</span>
    <span class="token hvariable">add</span> <span class="token hvariable">x</span> <span class="token hvariable">y</span> <span class="token operator">=</span> <span class="token constant">Prettyprint</span> <span class="token operator">$</span> <span class="token string">"("</span> <span class="token operator">++</span> <span class="token hvariable">prettyprint</span> <span class="token hvariable">x</span> <span class="token operator">++</span> <span class="token string">" + "</span> <span class="token operator">++</span> <span class="token hvariable">prettyprint</span> <span class="token hvariable">y</span> <span class="token operator">++</span> <span class="token string">")"</span>

<span class="token keyword">instance</span> <span class="token constant">MulAlg</span> <span class="token constant">Prettyprint</span> <span class="token keyword">where</span>
    <span class="token hvariable">mul</span> <span class="token hvariable">x</span> <span class="token hvariable">y</span> <span class="token operator">=</span> <span class="token constant">View</span> <span class="token operator">$</span> <span class="token string">"("</span> <span class="token operator">++</span> <span class="token hvariable">prettyprint</span> <span class="token hvariable">x</span> <span class="token operator">++</span> <span class="token string">" * "</span> <span class="token operator">++</span> <span class="token hvariable">prettyprint</span> <span class="token hvariable">y</span> <span class="token operator">++</span> <span class="token string">")"</span>
</code></pre>
<p>这里的形式已经和<a href="https://www.cs.rutgers.edu/~ccshan/tagless/jfp.pdf" target="_blank" rel="external">“Finally Tagless, Partially Evaluated”</a>中所提出的基本相同了，只不过在Haskell中不需要将MulAlg定义成ExpAlg的subclass，我们可以直接独立的定义这个typeclass：</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token keyword">class</span> <span class="token constant">MulAlg</span> <span class="token hvariable">t</span> <span class="token keyword">where</span>
    <span class="token hvariable">mul</span> <span class="token operator">::</span> <span class="token hvariable">t</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token operator">-></span> <span class="token hvariable">t</span>
</code></pre>
<p>这样所有含有乘法类型的表达式的类型值为<code>(ExpAlg t, MulAlg t) =&gt; t</code>。我们同样不需要更改已有的代码便能实现两边的扩展。</p>
<p>这里用到的“Hutton’s Razor”的例子所涉及到的都是Int类型，如果我们想在这个语言里面加入double，该如何实现呢？</p>
<p>答案是用Phantom types。我们给<code>ExpAlg</code>一个类型变量这样t从Type变成了<code>Type-&gt;Type</code>.</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token keyword">class</span> <span class="token constant">ExpAlg</span> <span class="token hvariable">t</span> <span class="token keyword">where</span>
    <span class="token hvariable">litI</span> <span class="token operator">::</span> <span class="token constant">Int</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token constant">Int</span>
    <span class="token hvariable">plusI</span> <span class="token operator">::</span> <span class="token hvariable">t</span> <span class="token constant">Int</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token constant">Int</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token constant">Int</span>
    <span class="token hvariable">litD</span> <span class="token operator">::</span> <span class="token constant">Double</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token constant">Double</span>
    <span class="token hvariable">plusD</span> <span class="token operator">::</span> <span class="token hvariable">t</span> <span class="token constant">Double</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token constant">Double</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token constant">Double</span>
</code></pre>
<p>注意到表达式ExpAlg并没有t这个值，所以我们称其为<em>phantom type</em>，它只是个假变量用来限制表达式的类型。</p>
<h2 id="The-very-beginning-problem"><a href="#The-very-beginning-problem" class="headerlink" title="The very beginning problem"></a>The very beginning problem</h2><blockquote>
<p>那么我们能不能找到一种方法在保留HOAS优势的同时简单地支持这些操作呢？</p>
</blockquote>
<p>现在我们有这样一个typeclass:</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token keyword">class</span> <span class="token constant">Language</span> <span class="token hvariable">t</span> <span class="token keyword">where</span> 
    <span class="token hvariable">app</span> <span class="token operator">::</span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token hvariable">b</span>
    <span class="token operator">...</span><span class="token punctuation">(</span><span class="token hvariable">more</span> <span class="token hvariable">method</span><span class="token punctuation">)</span>
</code></pre>
<p>而且我们需要这样一个函数lam:</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token hvariable">lam</span> <span class="token operator">::</span> <span class="token constant">Language</span> <span class="token hvariable">t</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token hvariable">b</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span>
</code></pre>
<p>在language class中并没有接受这个函数的constructor，或许我们可以实现instance Language PrettyPrint？</p>
<p>很明显方法是不可行的，我们没有办法得到一个<code>t (a -&gt; b)</code>这么个东西，<a href="http://link.zhihu.com/?target=http%3A//ecee.colorado.edu/ecen5533/fall11/reading/free.pdf" target="_blank" rel="external">Theorems for Free!</a>这篇文章中给了具体的证明。</p>
<p>所以想法变成了能不能改变t这个类型签名，而且我们为了要生成一个<code>t (a-&gt;b)</code>给app，所以假设新的类型签名为unknown，则现在lam：</p>
<pre class=" language-has"><code class="language-has">lam :: (unknown a -> unknown b) -> t (a -> b)
</code></pre>
<p>而且我们是可以生成unknown a的，通过得到一个unknown b就可以转换为<code>t (a -&gt; b)</code>。</p>
<p>unknown的类型呼之欲出：unknown x = t (a -&gt; x)。</p>
<p>根据自反性，我们很快得到一个unknown a(<code>t (a -&gt; a)</code>)。</p>
<p>我们也可以通过一个unknown b生成<code>t (a -&gt; b)</code>（本身即是）。</p>
<p>现在我们可以写出unknown了把它取名为Next：</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token keyword">newtype</span> <span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token hvariable">b</span> <span class="token operator">=</span> <span class="token constant">Next</span> <span class="token punctuation">{</span> <span class="token hvariable">unNext</span> <span class="token operator">::</span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

<span class="token hvariable">lam</span> <span class="token operator">::</span> <span class="token constant">SKI</span> <span class="token hvariable">t</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token hvariable">b</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span>
<span class="token hvariable">lam</span> <span class="token hvariable">f</span> <span class="token operator">=</span> <span class="token hvariable">unNext</span> <span class="token operator">$</span> <span class="token hvariable">f</span> <span class="token punctuation">(</span><span class="token constant">Next</span> <span class="token hvariable">i</span><span class="token punctuation">)</span>
</code></pre>
<p>再来看看我们需要在我们的Language中添加什么，首先我们需要一个unknown a，即<code>t (a -&gt; a)</code>，返回自身的一个method。同时为了用户能在lam中用到原来的term需要再添加一个<code>conv:: t a -&gt; Next t b a</code>，在Language中添加一个<code>t a -&gt; t (b -&gt; a)</code>。现在看看我们的Language是不是完备了：</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token keyword">class</span> <span class="token constant">Language</span> <span class="token hvariable">t</span> <span class="token keyword">where</span>
    <span class="token hvariable">app</span> <span class="token operator">::</span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token hvariable">b</span>
    <span class="token hvariable">i</span> <span class="token operator">::</span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">a</span><span class="token punctuation">)</span>
    <span class="token hvariable">k</span> <span class="token operator">::</span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">a</span><span class="token punctuation">)</span>

<span class="token keyword">instance</span> <span class="token constant">Language</span> <span class="token hvariable">t</span> <span class="token operator">=></span> <span class="token constant">Language</span> <span class="token punctuation">(</span><span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token keyword">where</span>
    <span class="token hvariable">app</span> <span class="token operator">::</span> <span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token punctuation">(</span><span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">c</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token hvariable">c</span>
    <span class="token hvariable">app</span> <span class="token operator">=</span> <span class="token builtin">undefined</span>
    <span class="token hvariable">i</span> <span class="token operator">=</span> <span class="token hvariable">conv</span> <span class="token hvariable">i</span>
    <span class="token hvariable">k</span> <span class="token operator">=</span> <span class="token hvariable">conv</span> <span class="token hvariable">k</span>

<span class="token hvariable">conv</span> <span class="token operator">::</span> <span class="token constant">Language</span> <span class="token hvariable">t</span> <span class="token operator">=></span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">b</span> <span class="token hvariable">a</span>
<span class="token hvariable">conv</span> <span class="token hvariable">x</span> <span class="token operator">=</span> <span class="token constant">Next</span> <span class="token punctuation">(</span><span class="token hvariable">app</span> <span class="token hvariable">k</span> <span class="token hvariable">x</span><span class="token punctuation">)</span>
</code></pre>
<p>理论上来说我们要把原来class中的基本construct lisft到Next里面去，现在i与k都可以实现，但是会发现app无法lift进Next里的。这里unwrap掉app的类型，会得到：</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token hvariable">app</span> <span class="token operator">::</span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">c</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">c</span><span class="token punctuation">)</span>
</code></pre>
<p>如果对组合逻辑熟悉的话，可以发现这其实就是SKI组合子中的S，所以只要把这个类型作为基础method加入我们的Language里，然后用conv实现就可以了。这样我们的Language整个就是SKI Combinator。它对于无类型的Lambda演算来是完备的，如果我们的language是有类型的话，可以手动再加上一个Y Combinator。事实上这并不是minimal的系统，因为I还可以用S、K来表达：<strong>SKK</strong>x → <strong>K</strong>x(<strong>K</strong>x) → x</p>
<p>SKI组合子的实现:</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token comment" spellcheck="true">{-# LANGUAGE
    MultiParamTypeClasses,
    RankNTypes,
    ScopedTypeVariables,
    FlexibleInstances,
    FlexibleContexts,
    UndecidableInstances,
    IncoherentInstances,
    PolyKinds #-}</span>

<span class="token keyword">class</span> <span class="token constant">SKI</span> <span class="token hvariable">t</span> <span class="token keyword">where</span>
    <span class="token hvariable">app</span> <span class="token operator">::</span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token hvariable">b</span>
    <span class="token hvariable">s</span> <span class="token operator">::</span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">c</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">c</span><span class="token punctuation">)</span>
    <span class="token hvariable">k</span> <span class="token operator">::</span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">a</span><span class="token punctuation">)</span>
    <span class="token hvariable">i</span> <span class="token operator">::</span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">a</span><span class="token punctuation">)</span>

<span class="token keyword">newtype</span> <span class="token constant">Prettyprint</span> <span class="token hvariable">x</span> <span class="token operator">=</span> <span class="token constant">Prettyprint</span> <span class="token punctuation">{</span> <span class="token hvariable">prettyprint</span> <span class="token operator">::</span> <span class="token constant">String</span> <span class="token punctuation">}</span>

<span class="token keyword">instance</span> <span class="token constant">SKI</span> <span class="token constant">Prettyprint</span> <span class="token keyword">where</span>
    <span class="token hvariable">app</span> <span class="token hvariable">f</span> <span class="token hvariable">x</span> <span class="token operator">=</span> <span class="token constant">Prettyprint</span> <span class="token operator">$</span> <span class="token string">"("</span> <span class="token operator">++</span> <span class="token hvariable">prettyprint</span> <span class="token hvariable">f</span> <span class="token operator">++</span> <span class="token string">" "</span> <span class="token operator">++</span> <span class="token hvariable">prettyprint</span> <span class="token hvariable">x</span> <span class="token operator">++</span> <span class="token string">")"</span>
    <span class="token hvariable">s</span> <span class="token operator">=</span> <span class="token constant">Prettyprint</span> <span class="token string">"S"</span>
    <span class="token hvariable">k</span> <span class="token operator">=</span> <span class="token constant">Prettyprint</span> <span class="token string">"K"</span>
    <span class="token hvariable">i</span> <span class="token operator">=</span> <span class="token constant">Prettyprint</span> <span class="token string">"I"</span>

<span class="token keyword">data</span> <span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token hvariable">b</span> <span class="token operator">=</span> <span class="token constant">Fast</span> <span class="token punctuation">(</span><span class="token hvariable">t</span> <span class="token hvariable">b</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token constant">Slow</span> <span class="token punctuation">(</span><span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token hvariable">unNext</span> <span class="token operator">::</span> <span class="token constant">SKI</span> <span class="token hvariable">t</span> <span class="token operator">=></span> <span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span>
<span class="token hvariable">unNext</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">x</span>
<span class="token hvariable">unNext</span> <span class="token punctuation">(</span><span class="token constant">Fast</span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">app</span> <span class="token hvariable">k</span> <span class="token hvariable">x</span>

<span class="token keyword">instance</span> <span class="token constant">SKI</span> <span class="token hvariable">t</span> <span class="token operator">=></span> <span class="token constant">SKI</span> <span class="token punctuation">(</span><span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token keyword">where</span>
    <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token constant">Fast</span> <span class="token hvariable">f</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token constant">Fast</span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">Fast</span> <span class="token operator">$</span> <span class="token hvariable">app</span> <span class="token hvariable">f</span> <span class="token hvariable">x</span>
    <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">f</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">Slow</span> <span class="token operator">$</span> <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token hvariable">app</span> <span class="token hvariable">s</span> <span class="token hvariable">f</span><span class="token punctuation">)</span> <span class="token hvariable">x</span>
    <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">f</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token constant">Fast</span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">f</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token operator">$</span> <span class="token hvariable">app</span> <span class="token hvariable">k</span> <span class="token hvariable">x</span><span class="token punctuation">)</span>
    <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token constant">Fast</span> <span class="token hvariable">f</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token operator">$</span> <span class="token hvariable">app</span> <span class="token hvariable">k</span> <span class="token hvariable">f</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">x</span><span class="token punctuation">)</span>
    <span class="token hvariable">s</span> <span class="token operator">=</span> <span class="token constant">Fast</span> <span class="token hvariable">s</span>
    <span class="token hvariable">k</span> <span class="token operator">=</span> <span class="token constant">Fast</span> <span class="token hvariable">k</span>
    <span class="token hvariable">i</span> <span class="token operator">=</span> <span class="token constant">Fast</span> <span class="token hvariable">i</span>

<span class="token hvariable">lam</span> <span class="token operator">::</span> <span class="token constant">SKI</span> <span class="token hvariable">t</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token hvariable">b</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span>
<span class="token hvariable">lam</span> <span class="token hvariable">f</span> <span class="token operator">=</span> <span class="token hvariable">unNext</span> <span class="token operator">$</span> <span class="token hvariable">f</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">i</span><span class="token punctuation">)</span>

<span class="token hvariable">c</span> <span class="token operator">::</span> <span class="token constant">SKI</span> <span class="token hvariable">t</span> <span class="token operator">=></span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">c</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">c</span><span class="token punctuation">)</span>
<span class="token hvariable">c</span> <span class="token operator">=</span> <span class="token hvariable">lam</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">abc</span> <span class="token operator">-></span> <span class="token hvariable">lam</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">lam</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token constant">Fast</span> <span class="token operator">$</span> <span class="token constant">Fast</span> <span class="token hvariable">abc</span><span class="token punctuation">)</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token operator">$</span> <span class="token constant">Fast</span> <span class="token hvariable">b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token hvariable">main</span> <span class="token operator">::</span> <span class="token constant">IO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token hvariable">main</span> <span class="token operator">=</span> <span class="token builtin">putStrLn</span> <span class="token operator">$</span> <span class="token hvariable">prettyprint</span> <span class="token hvariable">c</span>
</code></pre>
<p>输出结果：</p>
<p><code>((S ((S (K S)) ((S (K K)) ((S (K S)) ((S ((S (K S)) ((S (K K)) I))) (K I)))))) (K ((S (K K)) I)))</code></p>
<p>现在我们再回到“Hutton’s Razor”这个例子并给他加上SKI Combinator：</p>
<pre class=" language-haskell"><code class="language-haskell"><span class="token keyword">class</span> <span class="token constant">ExpAlg</span> <span class="token hvariable">t</span> <span class="token keyword">where</span>
    <span class="token hvariable">lit</span> <span class="token operator">::</span> <span class="token constant">Int</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token constant">Int</span>
    <span class="token hvariable">add</span> <span class="token operator">::</span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token constant">Int</span> <span class="token operator">-></span> <span class="token constant">Int</span> <span class="token operator">-></span> <span class="token constant">Int</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token constant">SKI</span> <span class="token hvariable">r</span> <span class="token keyword">where</span>
    <span class="token hvariable">app</span> <span class="token operator">::</span> <span class="token hvariable">r</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">r</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">r</span> <span class="token hvariable">b</span>
    <span class="token hvariable">s</span> <span class="token operator">::</span> <span class="token hvariable">r</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">c</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">c</span><span class="token punctuation">)</span>
    <span class="token hvariable">k</span> <span class="token operator">::</span> <span class="token hvariable">r</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">a</span><span class="token punctuation">)</span>
    <span class="token hvariable">i</span> <span class="token operator">::</span> <span class="token hvariable">r</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">a</span><span class="token punctuation">)</span>

<span class="token keyword">newtype</span> <span class="token constant">Prettyprint</span> <span class="token hvariable">n</span> <span class="token operator">=</span> <span class="token constant">Prettyprint</span> <span class="token punctuation">{</span> <span class="token hvariable">prettyprint</span> <span class="token operator">::</span> <span class="token constant">String</span> <span class="token punctuation">}</span>

<span class="token keyword">instance</span> <span class="token constant">ExpAlg</span> <span class="token constant">Prettyprint</span> <span class="token keyword">where</span>
    <span class="token hvariable">lit</span> <span class="token hvariable">n</span>   <span class="token operator">=</span> <span class="token constant">Prettyprint</span> <span class="token operator">$</span> <span class="token builtin">show</span> <span class="token hvariable">n</span>
    <span class="token hvariable">add</span> <span class="token operator">=</span> <span class="token constant">Prettyprint</span> <span class="token string">"add"</span>

<span class="token keyword">instance</span> <span class="token constant">SKI</span> <span class="token constant">Prettyprint</span> <span class="token keyword">where</span>
    <span class="token hvariable">app</span> <span class="token hvariable">f</span> <span class="token hvariable">x</span> <span class="token operator">=</span> <span class="token constant">Prettyprint</span> <span class="token operator">$</span> <span class="token string">"("</span> <span class="token operator">++</span> <span class="token hvariable">prettyprint</span> <span class="token hvariable">f</span> <span class="token operator">++</span> <span class="token string">" "</span> <span class="token operator">++</span> <span class="token hvariable">prettyprint</span> <span class="token hvariable">x</span> <span class="token operator">++</span> <span class="token string">")"</span>
    <span class="token hvariable">s</span> <span class="token operator">=</span> <span class="token constant">Prettyprint</span> <span class="token string">"S"</span>
    <span class="token hvariable">k</span> <span class="token operator">=</span> <span class="token constant">Prettyprint</span> <span class="token string">"K"</span>
    <span class="token hvariable">i</span> <span class="token operator">=</span> <span class="token constant">Prettyprint</span> <span class="token string">"I"</span>  

<span class="token keyword">newtype</span> <span class="token constant">Eval</span> <span class="token hvariable">x</span> <span class="token operator">=</span> <span class="token constant">Eval</span> <span class="token punctuation">{</span> <span class="token hvariable">eval</span> <span class="token operator">::</span> <span class="token hvariable">x</span> <span class="token punctuation">}</span>

<span class="token keyword">instance</span> <span class="token constant">ExpAlg</span> <span class="token constant">Eval</span> <span class="token keyword">where</span>
    <span class="token hvariable">lit</span> <span class="token hvariable">n</span>   <span class="token operator">=</span> <span class="token constant">Eval</span> <span class="token hvariable">n</span>
    <span class="token hvariable">add</span> <span class="token operator">=</span> <span class="token constant">Eval</span> <span class="token operator">$</span> <span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span>

<span class="token keyword">instance</span> <span class="token constant">SKI</span> <span class="token constant">Eval</span> <span class="token keyword">where</span> 
    <span class="token hvariable">app</span> <span class="token hvariable">f</span> <span class="token hvariable">x</span> <span class="token operator">=</span> <span class="token constant">Eval</span> <span class="token operator">$</span> <span class="token hvariable">eval</span> <span class="token hvariable">f</span> <span class="token operator">$</span> <span class="token hvariable">eval</span> <span class="token hvariable">x</span> 
    <span class="token hvariable">s</span> <span class="token operator">=</span> <span class="token constant">Eval</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">abc</span> <span class="token hvariable">ab</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">abc</span> <span class="token hvariable">a</span> <span class="token punctuation">(</span><span class="token hvariable">ab</span> <span class="token hvariable">a</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token hvariable">k</span> <span class="token operator">=</span> <span class="token constant">Eval</span> <span class="token builtin">const</span>
    <span class="token hvariable">i</span> <span class="token operator">=</span> <span class="token constant">Eval</span> <span class="token builtin">id</span>

<span class="token keyword">data</span> <span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token hvariable">b</span> <span class="token operator">=</span> <span class="token constant">Fast</span> <span class="token punctuation">(</span><span class="token hvariable">t</span> <span class="token hvariable">b</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token constant">Slow</span> <span class="token punctuation">(</span><span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token hvariable">unNext</span> <span class="token operator">::</span> <span class="token constant">SKI</span> <span class="token hvariable">t</span> <span class="token operator">=></span> <span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span> <span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span>
<span class="token hvariable">unNext</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">x</span>
<span class="token hvariable">unNext</span> <span class="token punctuation">(</span><span class="token constant">Fast</span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">app</span> <span class="token hvariable">k</span> <span class="token hvariable">x</span>

<span class="token keyword">instance</span> <span class="token constant">SKI</span> <span class="token hvariable">t</span> <span class="token operator">=></span> <span class="token constant">SKI</span> <span class="token punctuation">(</span><span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token keyword">where</span>
    <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token constant">Fast</span> <span class="token hvariable">f</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token constant">Fast</span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">Fast</span> <span class="token operator">$</span> <span class="token hvariable">app</span> <span class="token hvariable">f</span> <span class="token hvariable">x</span>
    <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">f</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">Slow</span> <span class="token operator">$</span> <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token hvariable">app</span> <span class="token hvariable">s</span> <span class="token hvariable">f</span><span class="token punctuation">)</span> <span class="token hvariable">x</span>
    <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">f</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token constant">Fast</span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">f</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token operator">$</span> <span class="token hvariable">app</span> <span class="token hvariable">k</span> <span class="token hvariable">x</span><span class="token punctuation">)</span>
    <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token constant">Fast</span> <span class="token hvariable">f</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token operator">$</span> <span class="token hvariable">app</span> <span class="token hvariable">k</span> <span class="token hvariable">f</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">x</span><span class="token punctuation">)</span>
    <span class="token hvariable">s</span> <span class="token operator">=</span> <span class="token constant">Fast</span> <span class="token hvariable">s</span>
    <span class="token hvariable">k</span> <span class="token operator">=</span> <span class="token constant">Fast</span> <span class="token hvariable">k</span>
    <span class="token hvariable">i</span> <span class="token operator">=</span> <span class="token constant">Fast</span> <span class="token hvariable">i</span>

<span class="token keyword">instance</span> <span class="token constant">ExpAlg</span> <span class="token hvariable">t</span> <span class="token operator">=></span> <span class="token constant">ExpAlg</span> <span class="token punctuation">(</span><span class="token constant">Next</span> <span class="token hvariable">t</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token keyword">where</span>
    <span class="token hvariable">lit</span> <span class="token hvariable">x</span> <span class="token operator">=</span> <span class="token constant">Fast</span> <span class="token punctuation">(</span><span class="token hvariable">lit</span> <span class="token hvariable">x</span><span class="token punctuation">)</span>
    <span class="token hvariable">add</span> <span class="token operator">=</span> <span class="token constant">Fast</span> <span class="token hvariable">add</span>

<span class="token keyword">class</span> <span class="token constant">NT</span> <span class="token hvariable">l</span> <span class="token hvariable">r</span> <span class="token keyword">where</span>
    <span class="token hvariable">conv</span> <span class="token operator">::</span> <span class="token hvariable">l</span> <span class="token hvariable">t</span> <span class="token operator">-></span> <span class="token hvariable">r</span> <span class="token hvariable">t</span>

<span class="token keyword">instance</span> <span class="token constant">NT</span> <span class="token hvariable">l</span> <span class="token hvariable">r</span> <span class="token operator">=></span> <span class="token constant">NT</span> <span class="token hvariable">l</span> <span class="token punctuation">(</span><span class="token constant">Next</span> <span class="token hvariable">r</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token keyword">where</span>
    <span class="token hvariable">conv</span> <span class="token operator">=</span> <span class="token constant">Fast</span><span class="token operator"> . </span><span class="token hvariable">conv</span>

<span class="token keyword">instance</span> <span class="token constant">NT</span> <span class="token hvariable">x</span> <span class="token hvariable">x</span> <span class="token keyword">where</span>
    <span class="token hvariable">conv</span> <span class="token operator">=</span> <span class="token builtin">id</span>

<span class="token keyword">instance</span> <span class="token constant">NT</span> <span class="token punctuation">(</span><span class="token constant">Next</span> <span class="token hvariable">r</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token constant">Next</span> <span class="token hvariable">r</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token keyword">where</span>
    <span class="token hvariable">conv</span> <span class="token operator">=</span> <span class="token builtin">id</span>

<span class="token hvariable">lam</span> <span class="token operator">::</span> <span class="token hvariable">forall</span> <span class="token hvariable">r</span> <span class="token hvariable">a</span> <span class="token hvariable">b</span><span class="token punctuation">.</span> <span class="token constant">SKI</span> <span class="token hvariable">r</span> <span class="token operator">=></span>
 <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token hvariable">forall</span> <span class="token hvariable">k</span><span class="token punctuation">.</span> <span class="token constant">NT</span> <span class="token punctuation">(</span><span class="token constant">Next</span> <span class="token hvariable">r</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token hvariable">k</span> <span class="token operator">=></span> <span class="token hvariable">k</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">(</span><span class="token constant">Next</span> <span class="token hvariable">r</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token hvariable">b</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">r</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span><span class="token punctuation">)</span>
<span class="token hvariable">lam</span> <span class="token hvariable">f</span> <span class="token operator">=</span> <span class="token hvariable">unNext</span> <span class="token operator">$</span> <span class="token hvariable">f</span> <span class="token punctuation">(</span><span class="token hvariable">conv</span> <span class="token punctuation">(</span><span class="token constant">Slow</span> <span class="token hvariable">i</span> <span class="token operator">::</span> <span class="token constant">Next</span> <span class="token hvariable">r</span> <span class="token hvariable">a</span> <span class="token hvariable">a</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token hvariable">c</span> <span class="token operator">::</span> <span class="token constant">SKI</span> <span class="token hvariable">t</span> <span class="token operator">=></span> <span class="token hvariable">t</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">c</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">c</span><span class="token punctuation">)</span>
<span class="token hvariable">c</span> <span class="token operator">=</span> <span class="token hvariable">lam</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">abc</span> <span class="token operator">-></span> <span class="token hvariable">lam</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">lam</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token hvariable">app</span> <span class="token hvariable">abc</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token hvariable">b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token hvariable">double</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token constant">SKI</span> <span class="token hvariable">r</span> <span class="token punctuation">,</span> <span class="token constant">ExpAlg</span> <span class="token hvariable">r</span> <span class="token punctuation">)</span><span class="token operator">=></span> <span class="token hvariable">r</span> <span class="token punctuation">(</span><span class="token constant">Int</span> <span class="token operator">-></span> <span class="token constant">Int</span><span class="token punctuation">)</span>
<span class="token hvariable">double</span> <span class="token operator">=</span> <span class="token hvariable">lam</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">x</span> <span class="token operator">-></span> <span class="token hvariable">app</span> <span class="token punctuation">(</span><span class="token hvariable">app</span> <span class="token hvariable">add</span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token hvariable">x</span><span class="token punctuation">)</span>

<span class="token hvariable">main</span> <span class="token operator">::</span> <span class="token constant">IO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token hvariable">main</span> <span class="token operator">=</span> <span class="token builtin">putStrLn</span> <span class="token operator">$</span> <span class="token hvariable">prettyprint</span> <span class="token hvariable">double</span>
</code></pre>
<p>double这个函数将输入的数加倍，用我们的language输出为：</p>
<p><code>((S ((S (K add)) I)) I)</code></p>
<p>如果我们再加上Y Combinator就可以实现这个表达式的计算：</p>
<p><code>Fix (((S ((S (K add)) I)) I))</code></p>
<p>其中<code>eval (Fix f) = (eval f) (eval (Fix f))</code>。</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>为了实现一个embed domain specified language(EDSL)，我们首先考虑用Haskell这个metalanguage用HOAS来实现lambda表达式的binding。同时为了解决expression problem我们用tagless的方法将lambda表达式用SKI Combinator的方式来表示，让我们能“看进”一个lambda表达式，了解他的结构，实现诸如prettyprint的功能。</p>
<p>这样我们的EDSL拥有了如下的feature：</p>
<ol>
<li>支持typed的lambda calculus。</li>
<li>type safe，可以利用Haskell的类型系统。</li>
<li>有很好的extensibility，方便地添加类型、方法，易于维护。</li>
</ol>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Expression_problem" target="_blank" rel="external">Expression problem</a></p>
<p><a href="https://link.zhihu.com/?target=http%3A//link.springer.com/chapter/10.1007/978-3-642-31057-7_2" target="_blank" rel="external">Extensibility for the Masses</a></p>
<p><a href="https://link.zhihu.com/?target=http%3A//journals.cambridge.org/action/displayAbstract%3FfromPage%3Donline%26aid%3D6171376%26fulltextType%3DRA%26fileId%3DS0956796809007205" target="_blank" rel="external">Finally tagless, partially evaluated: Tagless staged interpreters for simpler typed languages</a></p>
<p><a href="https://link.zhihu.com/?target=https%3A//oleksandrmanzyuk.wordpress.com/2014/06/18/from-object-algebras-to-finally-tagless-interpreters-2/" target="_blank" rel="external">From Object Algebras to Finally Tagless Interpreters</a></p>
<p><a href="https://link.zhihu.com/?target=https%3A//en.wikibooks.org/wiki/Haskell/GADT" target="_blank" rel="external">Haskell/GADT</a></p>
<p><a href="http://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Lambda_calculus" target="_blank" rel="external">Lambda calculus</a></p>

    

    
</div>


                

                <!-- Post Comments -->
                
                    




                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/03/28/'spacemacs+proof-general+coq'/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/face.png" alt="Peterson Xu's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        pcxu@mail.ustc.edu.cn
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto:pcxu@mail.ustc.edu.cn" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/06/">六月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">三月 2017<span class="sidebar_archives-count">3</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    
        <li>
            <a href="http://home.ustc.edu.cn/~pcxu/" title="About">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                About
            </a>
        </li>
        
            <li class="divider"></li>
        
    
        <li>
            <a href="/links/" title="友情链接">
                
                友情链接
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    
        <a href="http://weibo.com/5529226578/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-weibo.png);">
                <span class="visuallyhidden">Weibo</span>
            </button><!--
     --></a>
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/Poytr1" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    
        <a href="http://space.bilibili.com/22190119/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-bilibili.png);">
                <span class="visuallyhidden">Bilibili</span>
            </button><!--
     --></a>
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;Freedom Is Slavery Ignorance Is Strength
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->
<script src="/js/lazyload.min.js"></script>
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- Swiftye -->


<!-- Local Search-->


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->


                </main>
            </div>
        </body>
    
</html>
